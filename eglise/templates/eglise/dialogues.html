{% extends 'base.html' %}
{% load static %}

{% block content %}
  <style>
    /* --- BADGES JAUNE / ROUGE --- */
    .badge-green {
      position: absolute;
      top: 10px;
      right: 15px; /* ajuste selon la taille de l'avatar et badge jaune */
      min-width: 16px;
      height: 16px;
      background: #4caf50;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
    }
    .dialogue-item {
      position: relative; /* nÃ©cessaire pour que badge-green soit positionnÃ© par rapport au dialogue-item */
    }
    
    .badge-yellow-count {
      display: inline-block;
      background: #f5c60aff;
      color: #000;
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 6px;
    }
    .badge-red-count {
      display: inline-block;
      background: #ff4d4f;
      color: #fff;
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 12px;
      margin-left: 6px;
    }
    
    .badge-yellow {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      background: #ffcc00;
      margin-right: 6px;
    }
    
    .badge-red {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      background: #ff4d4f;
      margin-right: 6px;
    }
    
    /* --- CONTAINER GÃ‰NÃ‰RAL --- */
    .dialogues-container {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
      position: relative;
    }
    
    /* --- HEADER --- */
    .dialogues-header {
      background: #128c7e;
      color: #fff;
      padding: 15px 20px;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
      text-align: center;
      position: relative;
    }
    
    /* --- ICONE ðŸ”” --- */
    .notif-bell {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 22px;
      cursor: pointer;
    }
    
    /* --- BOUTON INVITATIONS --- */
    .invites-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: #ffeb3b;
      color: #000;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      z-index: 10;
    }
    
    /* --- CONTAINER GÃ‰NÃ‰RAL --- */
    .dialogues-container {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
      position: relative;
    }
    
    /* --- HEADER --- */
    .dialogues-header {
      background: #128c7e;
      color: #fff;
      padding: 15px 20px;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
      text-align: center;
      position: relative;
    }
    
    /* --- ICONE ðŸ”” --- */
    .notif-bell {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 22px;
      cursor: pointer;
    }
    
    /* --- BOUTON INVITATIONS --- */
    .invites-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: #ffeb3b;
      color: #000;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      z-index: 10;
    }
    
    /* --- BARRE DE RECHERCHE --- */
    .search-bar {
      background: #f5f5f5;
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .search-input {
      width: 90%;
      max-width: 450px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
      transition: all 0.2s;
      text-align: center;
    }
    
    .search-input:focus {
      border-color: #128c7e;
      box-shadow: 0 0 5px rgba(18, 140, 126, 0.5);
    }
    
    /* --- LISTE DES DISCUSSIONS --- */
    .dialogues-list {
      flex: 1;
      overflow-y: auto;
      background: #fafafa;
    }
    
    .dialogue-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      border-bottom: 1px solid #f0f0f0;
      text-decoration: none;
      color: #000;
      transition: background 0.2s, transform 0.1s;
      position: relative;
    }
    
    .dialogue-item:hover {
      background: #f0f0f0;
      transform: scale(1.01);
    }
    
    .dialogue-item img {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .badge-yellow {
      position: absolute;
      top: 10px;
      right: 15px;
      width: 12px;
      height: 12px;
      background: #ffeb3b;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
    }
    
    .dialogue-details {
      flex-grow: 1;
      overflow: hidden;
    }
    
    .dialogue-details .name {
      font-weight: 600;
      font-size: 16px;
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .dialogue-details .last-message {
      color: #666;
      font-size: 14px;
      margin-top: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .dialogue-details .last-message-time {
      float: right;
      font-size: 12px;
      color: #999;
    }
    
    .invitation-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      background: #fffde7;
    }
    
    .invitation-item img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
    }
    
    .accept-btn,
    .reject-btn {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 13px;
      text-decoration: none;
      margin-left: 5px;
    }
    
    .accept-btn {
      background: #4caf50;
      color: #fff;
    }
    .reject-btn {
      background: #f44336;
      color: #fff;
    }
    
    /* --- INVITATIONS MASQUÃ‰ES POPUP --- */
    .invites-list {
      display: none;
      position: absolute;
      top: 60px;
      right: 15px;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 20;
    }
    
    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      .search-input {
        width: 95%;
        font-size: 14px;
      }
      .invites-list {
        width: 90%;
        right: 5%;
      }
    }
    @media (max-width: 600px) {
      .dialogue-item img {
        width: 45px;
        height: 45px;
      }
      .dialogue-details .name {
        font-size: 15px;
      }
      .dialogue-details .last-message {
        font-size: 13px;
      }
      .dialogues-container {
        border-radius: 0;
        box-shadow: none;
        height: 100vh;
      }
      .search-input {
        width: 92%;
        font-size: 14px;
      }
    }
  </style>
  <div class="dialogues-container">
    <div class="dialogues-header">
      <!-- icÃ´ne cliquable pour notifications -->
      <span id="notifBell" class="notif-bell" onclick="toggleInvitations()">
        ðŸ””{% if invitations_recues_count > 0 %}
          <span class="badge-yellow-count">{{ invitations_recues_count }}</span>
        {% endif %}
        {% if invitations_refusees_count > 0 %}
          <span class="badge-red-count">+{{ invitations_refusees_count }}</span>
        {% endif %}
      </span>

      ðŸ’¬ Discussions{% if invitations_recues %}
        <!-- bouton indiquant le nombre total d'invitations -->
        <span class="invites-btn" onclick="toggleInvitations()">{{ invitations_recues|length }}</span>
      {% endif %}
    </div>

    <!-- Barre de recherche -->
    <div class="search-bar">
      <input type="text" id="searchInput" class="search-input" placeholder="ðŸ” Rechercher un ami..." onkeyup="filterDiscussions()" />
    </div>

    <!-- POPUP INVITATIONS -->
    <div class="invites-list" id="invitesList" style="display:none;">
      <!-- INVITATIONS REÃ‡UES (jaune) -->
      {% if invitations_recues and invitations_recues|length > 0 %}
        <h4 style="padding:5px 15px; color:#333;">Invitations en attente</h4>
        {% for invitation in invitations_recues %}
          <div class="invitation-item">
            <div style="display:flex;align-items:center;">
              {% if invitation.emetteur.profile and invitation.emetteur.profile.image %}
                <img src="{{ invitation.emetteur.profile.image.url }}" alt="Profil" />
              {% else %}
                <img src="{% static 'eglise/icons/default-profile.png' %}" alt="Profil" />

                <img src="{% static 'icons/default-profile.png' %}" alt="Profil" />
              {% endif %}
              <span style="margin-left:8px;">{{ invitation.emetteur.username }}</span>
            </div>
            <div>
              <a href="{% url 'eglise:accepter_invitation' invitation.id %}" class="accept-btn">Accepter</a>
              <a href="{% url 'eglise:refuser_invitation' invitation.id %}" class="reject-btn">Refuser</a>
            </div>
          </div>
        {% endfor %}
      {% endif %}

      <!-- INVITATIONS REFUSÃ‰ES (rouge) -->
      {% if invitations_refusees and invitations_refusees|length > 0 %}
        <h4 style="padding:5px 15px; color:#333; margin-top:10px;">Invitations refusÃ©es</h4>
        {% for invitation in invitations_refusees %}
          <div class="invitation-item">
            <div style="display:flex;align-items:center;">
              {% if invitation.receveur.profile and invitation.receveur.profile.image %}
                <img src="{{ invitation.receveur.profile.image.url }}" alt="Profil" />
              {% else %}
                <img src="{% static 'eglise/icons/default-profile.png' %}" alt="Profil" />

                <img src="{% static 'icons/default-profile.png' %}" alt="Profil" />
              {% endif %}
              <span style="margin-left:8px;">{{ invitation.receveur.username }}</span>
            </div>
            <div style="display:flex; gap:5px;">
              <!-- Bouton Renvoyer (peut rester un lien GET si la vue accepte GET) -->
              <a href="{% url 'eglise:renvoyer_invitation' invitation.receveur.id %}" class="accept-btn">Renvoyer</a>

              <!-- Bouton Supprimer transformÃ© en formulaire POST -->
              <form method="POST" action="{% url 'eglise:annuler_invitation' invitation.receveur.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="reject-btn">Supprimer</button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% endif %}

      {% if not invitations_recues and not invitations_refusees %}
        <p style="padding:10px;text-align:center;">Aucune invitation pour le moment</p>
      {% endif %}
    </div>
    <!-- LISTE DES DISCUSSIONS -->
    <div class="dialogues-list" id="dialoguesList">
      {% if mes_discussions %}
        {% for d in mes_discussions %}
          <a href="{% url 'eglise:discussion_detail_user' d.correspondant.id %}" class="dialogue-item">
            {% if d.correspondant.has_new_invitation %}
              <span class="badge-yellow"></span>
            {% endif %}

            {% if d.correspondant.profile and d.correspondant.profile.image %}
              <img src="{{ d.correspondant.profile.image.url }}" alt="Profil" />
            {% else %}
              <img src="{% static 'eglise/icons/default-profile.png' %}" alt="Profil" />

              <img src="{% static 'icons/default-profile.png' %}" alt="Profil" />
            {% endif %}

            {% if d.non_lus_count > 0 %}
              <span class="badge-green">{{ d.non_lus_count }}</span>
            {% endif %}

            <div class="dialogue-details">
              <div class="name">{{ d.correspondant.username }}</div>
              <div class="last-message">
                {% if d.dernier_message %}
                  {{ d.dernier_message.contenu|truncatechars:40 }}
                  <span class="last-message-time">{{ d.dernier_message.date|date:'H:i' }}</span>
                {% else %}
                  Nouvelle discussion
                {% endif %}
              </div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <p style="padding:20px;text-align:center;">Aucune discussion pour le moment.</p>
      {% endif %}
    </div>
  </div>

  <script>
    function filterDiscussions() {
      const input = document.getElementById('searchInput')
      const filter = input.value.toLowerCase()
      const list = document.getElementById('dialoguesList')
      const items = list.getElementsByClassName('dialogue-item')
      for (let i = 0; i < items.length; i++) {
        const nameDiv = items[i].getElementsByClassName('name')[0]
        const txtValue = nameDiv.textContent || nameDiv.innerText
        items[i].style.display = txtValue.toLowerCase().includes(filter) ? '' : 'none'
      }
    }
    
    function toggleInvitations() {
      const invites = document.getElementById('invitesList')
      invites.style.display = invites.style.display === 'block' ? 'none' : 'block'
    }
  </script>
{% endblock %}
