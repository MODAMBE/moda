{% extends 'base.html' %}
{% block content %}
  <style>
    .feed {
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
    }
    .video-item {
      width: 100%;
      max-width: 720px;
      height: 75vh;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .actions {
      position: absolute;
      right: 12px;
      bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 30;
    }
    .info {
      position: absolute;
      left: 12px;
      bottom: 12px;
      color: white;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
      z-index: 30;
      max-width: 70%;
    }
    .btn-fab {
      background: rgba(255, 255, 255, 0.08);
      border: none;
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
    }
    .btn-like.active {
      background: #ff4d6d;
      color: white;
    }
  </style>

  <div class="feed">
    {% for v in videos %}
      <div class="video-item" data-id="{{ v.id }}">
        <video class="video-player" data-src="{{ v.video_file.url }}" playsinline muted loop preload="metadata" style="width:100%; height:100%; object-fit:cover;"></video>

        <div class="actions">
          <button class="btn-fab btn-like" data-id="{{ v.id }}">{{ v.likes.count }} ‚ù§Ô∏è</button>
          <a class="btn-fab" href="{% url 'app:download_video' v.id %}">‚¨á T√©l√©ch.</a>
          <a class="btn-fab" href="{% url 'app:chaine_detail' v.chaine.username %}">üë§ {{ v.chaine.nom|truncatechars:12 }}</a>
          {% if user == v.chaine.auteur %}
            <button class="btn-fab btn-delete" data-id="{{ v.id }}">üóë</button>
          {% endif %}
        </div>

        <div class="info">
          <h3 style="margin:0; color:white;">{{ v.titre }}</h3>
          <small style="color:rgba(255,255,255,0.85)">{{ v.chaine.nom }} ‚Ä¢ <span class="views-{{ v.id }}">{{ v.views }}</span> vues</small>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    /* feed.js fallback: if static not loaded, minimal inline */
    ;(function () {
      const items = document.querySelectorAll('.video-item')
      const options = { root: null, rootMargin: '0px', threshold: 0.6 }
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const video = entry.target.querySelector('video')
          if (entry.isIntersecting) {
            // attach hls if needed
            const src = video.dataset.src
            if (Hls && Hls.isSupported() && src && src.endsWith('.m3u8')) {
              if (!video._hls) {
                const hls = new Hls()
                hls.loadSource(src)
                hls.attachMedia(video)
                video._hls = hls
              }
            } else if (src && !video.src) {
              video.src = src
            }
            video.play().catch(() => {})
            // increment view once when plays (AJAX)
            fetch(`/api/increment_view/${entry.target.dataset.id}/`, {
              method: 'POST',
              headers: { 'X-CSRFToken': window.CSRF }
            })
              .then((r) => r.json())
              .then((data) => {
                const el = document.querySelector('.views-' + entry.target.dataset.id)
                if (el) el.textContent = data.views
              })
              .catch(() => {})
          } else {
            video.pause()
          }
        })
      }, options)
    
      items.forEach((it) => observer.observe(it))
    
      // Actions (like, delete)
      document.body.addEventListener('click', async (e) => {
        const likeBtn = e.target.closest('.btn-like')
        const delBtn = e.target.closest('.btn-delete')
        if (likeBtn) {
          const id = likeBtn.dataset.id
          const res = await fetch(`/api/like/${id}/`, { method: 'POST', headers: { 'X-CSRFToken': window.CSRF } })
          const data = await res.json()
          likeBtn.classList.toggle('active', data.liked)
          likeBtn.textContent = data.count + ' ‚ù§Ô∏è'
        } else if (delBtn) {
          if (!confirm('Supprimer cette vid√©o ?')) return
          const id = delBtn.dataset.id
          const res = await fetch(`/api/delete_video/${id}/`, { method: 'POST', headers: { 'X-CSRFToken': window.CSRF } })
          const data = await res.json()
          if (data.deleted) location.reload()
        }
      })
    })()
  </script>
{% endblock %}
