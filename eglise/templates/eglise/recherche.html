{% extends 'eglise/accueil.html' %}
{% load static %}

{% block content %}
  <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>

  <style>
    /* ======== STYLE GLOBAL (inchang√© sauf ajout du menu ...) ======== */
    #search-form {
      max-width: 850px;
      margin: 20px auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #search-input {
      flex: 1 1 60%;
      min-width: 180px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #search-button {
      flex: 1 1 30%;
      min-width: 100px;
      padding: 10px 20px;
      background: #87ceeb;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    #search-button:hover {
      background: #00bfff;
    }
    
    #back-home {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 10px 16px;
      background: #87ceeb;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      text-decoration: none;
      transition: 0.3s;
    }
    #back-home:hover {
      background: #00bfff;
    }
    
    .search-results {
      max-width: 850px;
      margin: 80px auto 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      margin-top: 30px;
      font-size: 1.2rem;
      color: #007bff;
      border-bottom: 2px solid #007bff;
      display: inline-block;
      padding-bottom: 3px;
    }
    
    .user-card {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 12px;
      background: #f8f9fc;
      transition: 0.3s;
    }
    .user-card:hover {
      transform: scale(1.02);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    
    .avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #007bff;
    }
    
    .btn-add-friend {
      background: #87ceeb;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 6px 14px;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-add-friend:hover {
      background: #00bfff;
    }
    
    .publication-card {
      background: #f9f9fb;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #007bff;
    }
    .publication-card p {
      margin: 5px 0;
      font-size: 14px;
      word-wrap: break-word;
    }
    
    .img-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
      margin-top: 10px;
    }
    .fb-img-card {
      position: relative;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
    }
    .fb-img-card img {
      width: 100%;
      height: 230px;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }
    .fb-img-card:hover img {
      transform: scale(1.1);
    }
    
    /* === Fen√™tre modale === */
    #fbViewer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }
    #fbViewerImg {
      max-width: 95%;
      max-height: 90%;
      margin-bottom: 15px;
      border-radius: 10px;
      transform: scale(1);
      transition: transform 0.4s ease;
    }
    #fbViewerImg.zoom {
      transform: scale(1.15);
    }
    
    /* === Bouton 3 points === */
    .menu-wrapper {
      position: relative;
      display: inline-block;
    }
    .menu-btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .menu-btn:hover {
      background: #0056b3;
    }
    
    .dropdown-menu {
      display: none;
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      padding: 8px 0;
      width: 160px;
      text-align: left;
      z-index: 10000;
    }
    .dropdown-menu button,
    .dropdown-menu a {
      background: none;
      border: none;
      width: 100%;
      padding: 10px 14px;
      text-align: left;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    .dropdown-menu button:hover,
    .dropdown-menu a:hover {
      background: #f1f1f1;
    }
    
    #prevImg,
    #nextImg {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 10px;
    }
    #prevImg {
      left: 20px;
    }
    #nextImg {
      right: 20px;
    }
    
    #closeFBViewer {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 2rem;
      color: #fff;
      cursor: pointer;
    }
    
    .download-btn {
      color: #28a745;
      text-decoration: none;
    }
    .download-btn:hover {
      color: #1e7e34;
    }
    
    @media (max-width: 768px) {
      .img-container {
        grid-template-columns: 1fr;
      }
      #fbViewerImg {
        max-width: 100%;
        max-height: 80%;
      }
    }
  </style>

  <a id="back-home" href="{% url 'eglise:accueil' %}">‚Üê Retour √† l'accueil</a>

  <form id="search-form" method="GET" action="{% url 'eglise:recherche_eglise' %}">
    <input type="text" id="search-input" name="q" value="{{ query }}" placeholder="Rechercher..." />
    <button id="search-button" type="submit">Rechercher</button>
  </form>

  <div class="search-results">
    <h2>R√©sultats de recherche pour ¬´ {{ query }} ¬ª</h2>

    {% if results_users %}
      <h3 class="section-title">Utilisateurs trouv√©s</h3>

      {% for user_found in results_users %}
        <div class="user-card">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            {% if user_found.profile.image %}
              <img src="{{ user_found.profile.image.url }}" class="avatar" />
            {% else %}

              <img src="{% static 'eglise/icons/default-profile.png' %}" class="avatar" />

              <img src="{% static 'icons/default-profile.png' %}" class="avatar" />

            {% endif %}
            <span>{{ user_found.username }}</span>
            {% if user.is_authenticated and user != user_found %}
              <form method="POST" action="{% url 'eglise:ajouter_ami' user_found.id %}" style="margin-left:10px;">
                {% csrf_token %}
                <button class="btn-add-friend">Ajouter / Discuter</button>
              </form>
            {% endif %}
          </div>
        </div>

        {% for pub in user_found.publications.all %}
          <div class="publication-card" id="pub{{ pub.id }}">
            {% if pub.titre %}
              <h4>{{ pub.titre }}</h4>
            {% endif %}
            {% if pub.contenu %}
              <p>{{ pub.contenu }}</p>
            {% endif %}
            {% if pub.medias.count > 0 %}
              <div class="img-container">
                {% for media in pub.medias.all %}
                  {% if media.type == 'image' %}
                    <div class="fb-img-card" onclick="openFBViewer({{ pub.id }}, {{ forloop.counter0 }}, {{ media.id }})">
                      <img src="{{ media.fichier.url }}" alt="image" />
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% empty %}
          <p class="no-result">Aucune publication personnelle.</p>
        {% endfor %}
      {% endfor %}
    {% else %}
      <p class="no-result">Aucun utilisateur trouv√©.</p>
    {% endif %}
  </div>

  <!-- ======== VIEWER ======== -->
  <div id="fbViewer">
    <span id="closeFBViewer">&times;</span>
    <img id="fbViewerImg" src="" alt="" />

    <div class="menu-wrapper">
      <button class="menu-btn" onclick="toggleMenu()">‚ãÆ</button>
      <div id="dropdownMenu" class="dropdown-menu">
        <button id="likeBtn">‚ù§Ô∏è <span id="likeCount">0</span></button>
        <button id="commentBtn">üí¨ Commenter</button>
        <button id="shareBtn">üîó Partager</button>
        <a id="downloadLink" class="download-btn" href="#" download>‚¨á T√©l√©charger</a>
      </div>
    </div>

    <button id="prevImg">&larr;</button>
    <button id="nextImg">&rarr;</button>
  </div>

  <script>
    let currentImages = []
    let currentIndex = 0
    let currentPubId = null
    
    function openFBViewer(pubId, index) {
      currentImages = Array.from(document.querySelectorAll(`#pub${pubId} .fb-img-card img`)).map((img) => img.src)
      currentIndex = index
      currentPubId = pubId
      updateFBViewer()
      document.getElementById('fbViewer').style.display = 'flex'
      const imgViewer = document.getElementById('fbViewerImg')
      imgViewer.classList.add('zoom')
      setTimeout(() => imgViewer.classList.remove('zoom'), 800)
      updateLikeCount()
    }
    
    function updateFBViewer() {
      const imgViewer = document.getElementById('fbViewerImg')
      const downloadLink = document.getElementById('downloadLink')
      imgViewer.src = currentImages[currentIndex]
      downloadLink.href = currentImages[currentIndex]
    }
    
    document.getElementById('closeFBViewer').onclick = () => (document.getElementById('fbViewer').style.display = 'none')
    document.getElementById('prevImg').onclick = () => {
      currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length
      updateFBViewer()
    }
    document.getElementById('nextImg').onclick = () => {
      currentIndex = (currentIndex + 1) % currentImages.length
      updateFBViewer()
    }
    
    function toggleMenu() {
      const menu = document.getElementById('dropdownMenu')
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block'
    }
    
    window.onclick = function (e) {
      if (!e.target.matches('.menu-btn')) {
        const dropdown = document.getElementById('dropdownMenu')
        if (dropdown.style.display === 'block') dropdown.style.display = 'none'
      }
    }
    
    function getCookie(name) {
      let cookieValue = null
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';')
        for (let cookie of cookies) {
          cookie = cookie.trim()
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
            break
          }
        }
      }
      return cookieValue
    }
    
    async function updateLikeCount() {
      const res = await fetch(`/publication/${currentPubId}/likes_count/`)
      const data = await res.json()
      document.getElementById('likeCount').textContent = data.likes_count
    }
    
    document.getElementById('likeBtn').onclick = async () => {
      const res = await fetch(`/publication/${currentPubId}/like/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      const data = await res.json()
      if (data.success) {
        document.getElementById('likeBtn').innerHTML = (data.liked ? '‚ù§Ô∏è' : 'ü§ç') + ' <span id="likeCount">' + data.likes_count + '</span>'
      }
    }
    
    document.getElementById('commentBtn').onclick = () => {
      window.location.href = `/publication/${currentPubId}/`
    }
    
    document.getElementById('shareBtn').onclick = () => {
      const shareUrl = window.location.origin + `/publication/${currentPubId}/`
      const shareData = {
        title: 'Publication',
        text: 'D√©couvre cette publication int√©ressante',
        url: shareUrl
      }
      if (navigator.share) navigator.share(shareData)
      else {
        navigator.clipboard.writeText(shareUrl)
        alert('Lien copi√© ‚úÖ')
      }
    }
  </script>
{% endblock %}
